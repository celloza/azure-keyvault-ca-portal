{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "2172966919425919066"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "githubRepo": {
      "type": "string",
      "defaultValue": "celloza/azure-keyvault-ca-portal"
    },
    "appTitle": {
      "type": "string"
    },
    "vwanHubName": {
      "type": "string"
    },
    "vwanHubRg": {
      "type": "string"
    }
  },
  "variables": {
    "suffix": "[uniqueString(resourceGroup().id)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-role-lookup",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "2525937826545817093"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "id-deployment-script",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script'), 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script'), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "ds-lookup-roles",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]",
                "scriptContent": "      echo \"Looking up Role IDs...\"\r\n      \r\n      STORAGE_TABLE_ID=$(az role definition list --name \"Storage Table Data Contributor\" --query \"[0].name\" -o tsv)\r\n      STORAGE_BLOB_ID=$(az role definition list --name \"Storage Blob Data Contributor\" --query \"[0].name\" -o tsv)\r\n      KV_ADMIN_ID=$(az role definition list --name \"Key Vault Administrator\" --query \"[0].name\" -o tsv)\r\n\r\n      # Handle cases where roles might not be found (fallback or error)\r\n      if [ -z \"$STORAGE_TABLE_ID\" ]; then echo \"Error: Storage Table role not found\"; exit 1; fi\r\n      if [ -z \"$STORAGE_BLOB_ID\" ]; then echo \"Error: Storage Blob role not found\"; exit 1; fi\r\n      if [ -z \"$KV_ADMIN_ID\" ]; then echo \"Error: Key Vault Admin role not found\"; exit 1; fi\r\n\r\n      # Output JSON\r\n      echo \"{\\\"storageTableRoleDefinitionId\\\": \\\"$STORAGE_TABLE_ID\\\", \\\"storageBlobRoleDefinitionId\\\": \\\"$STORAGE_BLOB_ID\\\", \\\"keyVaultAdminRoleDefinitionId\\\": \\\"$KV_ADMIN_ID\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    "
              },
              "dependsOn": [
                "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script'), 'acdd72a7-3385-48ef-bd42-f606fba81ae7'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-deployment-script')]"
              ]
            }
          ],
          "outputs": {
            "storageTableRoleDefinitionId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-lookup-roles'), '2023-08-01').outputs.storageTableRoleDefinitionId]"
            },
            "storageBlobRoleDefinitionId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-lookup-roles'), '2023-08-01').outputs.storageBlobRoleDefinitionId]"
            },
            "keyVaultAdminRoleDefinitionId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-lookup-roles'), '2023-08-01').outputs.keyVaultAdminRoleDefinitionId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-network",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17262197718754793083"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "defaultValue": "vnet-camanager"
            },
            "vnetAddressSpace": {
              "type": "array",
              "defaultValue": [
                "172.120.0.0/26"
              ]
            },
            "subnetPrefixes": {
              "type": "object",
              "defaultValue": {
                "app": "172.120.0.0/27",
                "pe": "172.120.0.32/27"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": "[parameters('vnetAddressSpace')]"
                },
                "subnets": [
                  {
                    "name": "snet-app",
                    "properties": {
                      "addressPrefix": "[parameters('subnetPrefixes').app]",
                      "delegations": [
                        {
                          "name": "delegation",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "snet-pe",
                    "properties": {
                      "addressPrefix": "[parameters('subnetPrefixes').pe]"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.azurewebsites.net",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', 'link-vault')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', format('privatelink.blob.{0}', environment().suffixes.storage), 'link-blob')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.azurewebsites.net', 'link-app')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurewebsites.net')]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "snetAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'snet-app')]"
            },
            "snetPeId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'snet-pe')]"
            },
            "pdnsVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
            },
            "pdnsBlobId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
            },
            "pdnsAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurewebsites.net')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-vwan",
      "resourceGroup": "[parameters('vwanHubRg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.vnetId.value]"
          },
          "vwanHubName": {
            "value": "[parameters('vwanHubName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "345709262846511547"
            }
          },
          "parameters": {
            "vwanHubName": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualHubs/hubVirtualNetworkConnections",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('vwanHubName'), 'conn-camanager-to-hub')]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "allowHubToRemoteVnetTransit": true,
                "allowRemoteVnetToUseHubVnetGateways": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "3261212200001215319"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "id-camanager",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-camanager')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-camanager'), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'id-camanager'), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-logging",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "suffix": {
            "value": "[variables('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "856860809415381348"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "suffix": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('log-camanager-{0}', parameters('suffix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('appi-camanager-{0}', parameters('suffix'))]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-camanager-{0}', parameters('suffix')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-camanager-{0}', parameters('suffix')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', format('appi-camanager-{0}', parameters('suffix'))), '2020-02-02').ConnectionString]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "suffix": {
            "value": "[variables('suffix')]"
          },
          "snetPeId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.snetPeId.value]"
          },
          "pdnsBlobId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.pdnsBlobId.value]"
          },
          "appIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "storageTableRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-role-lookup'), '2025-04-01').outputs.storageTableRoleDefinitionId.value]"
          },
          "storageBlobRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-role-lookup'), '2025-04-01').outputs.storageBlobRoleDefinitionId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "10304662702142199681"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "suffix": {
              "type": "string"
            },
            "snetPeId": {
              "type": "string"
            },
            "pdnsBlobId": {
              "type": "string"
            },
            "appIdentityPrincipalId": {
              "type": "string"
            },
            "storageTableRoleDefinitionId": {
              "type": "string",
              "defaultValue": "0a9a7e1f-b9d0-4cc4-a60d-0319cd74161d"
            },
            "storageBlobRoleDefinitionId": {
              "type": "string",
              "defaultValue": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[format('stcamanager{0}', parameters('suffix'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "publicNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', format('stcamanager{0}', parameters('suffix')), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', format('stcamanager{0}', parameters('suffix')), 'default', 'auditlogs')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', format('stcamanager{0}', parameters('suffix')), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-04-01",
              "name": "pe-st-blob",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('snetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "psc-st-blob",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', 'pe-st-blob', 'pdns-blob-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-blob-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('pdnsBlobId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', 'pe-st-blob')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix'))), parameters('appIdentityPrincipalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobRoleDefinitionId')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobRoleDefinitionId'))]",
                "principalId": "[parameters('appIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix'))), parameters('appIdentityPrincipalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageTableRoleDefinitionId')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageTableRoleDefinitionId'))]",
                "principalId": "[parameters('appIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('stcamanager{0}', parameters('suffix')))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[format('stcamanager{0}', parameters('suffix'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-network')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-role-lookup')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "suffix": {
            "value": "[variables('suffix')]"
          },
          "snetPeId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.snetPeId.value]"
          },
          "pdnsVaultId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.pdnsVaultId.value]"
          },
          "appIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          },
          "keyVaultAdminRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-role-lookup'), '2025-04-01').outputs.keyVaultAdminRoleDefinitionId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "10594458460858803610"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "suffix": {
              "type": "string"
            },
            "snetPeId": {
              "type": "string"
            },
            "pdnsVaultId": {
              "type": "string"
            },
            "appIdentityPrincipalId": {
              "type": "string"
            },
            "tenantId": {
              "type": "string"
            },
            "keyVaultAdminRoleDefinitionId": {
              "type": "string",
              "defaultValue": "00482a5a-887f-4fb3-b363-3b7fe8e74483"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "[format('kv-cam-{0}', parameters('suffix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "publicNetworkAccess": "Disabled",
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-04-01",
              "name": "pe-kv-camanager",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('snetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "psc-kv",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix')))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', 'pe-kv-camanager', 'pdns-kv-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-vaultcore-azure-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('pdnsVaultId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', 'pe-kv-camanager')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix')))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix'))), parameters('appIdentityPrincipalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultAdminRoleDefinitionId')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultAdminRoleDefinitionId'))]",
                "principalId": "[parameters('appIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix')))]"
              ]
            }
          ],
          "outputs": {
            "vaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('kv-cam-{0}', parameters('suffix'))), '2023-02-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-network')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-role-lookup')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-appservice",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "suffix": {
            "value": "[variables('suffix')]"
          },
          "snetAppId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.snetAppId.value]"
          },
          "snetPeId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.snetPeId.value]"
          },
          "pdnsAppId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-network'), '2025-04-01').outputs.pdnsAppId.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-logging'), '2025-04-01').outputs.appInsightsConnectionString.value]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          },
          "githubRepo": {
            "value": "[parameters('githubRepo')]"
          },
          "appTitle": {
            "value": "[parameters('appTitle')]"
          },
          "identityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01').outputs.id.value]"
          },
          "identityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01').outputs.clientId.value]"
          },
          "keyVaultUrl": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.vaultUri.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "auditTableName": {
            "value": "auditlogs"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4332839011812069545"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "suffix": {
              "type": "string"
            },
            "snetAppId": {
              "type": "string"
            },
            "snetPeId": {
              "type": "string"
            },
            "pdnsAppId": {
              "type": "string"
            },
            "keyVaultUrl": {
              "type": "string"
            },
            "tenantId": {
              "type": "string"
            },
            "githubRepo": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "appInsightsConnectionString": {
              "type": "string"
            },
            "auditTableName": {
              "type": "string"
            },
            "appTitle": {
              "type": "string"
            },
            "identityId": {
              "type": "string"
            },
            "identityClientId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "plan-camanager",
              "location": "[parameters('location')]",
              "kind": "linux",
              "sku": {
                "name": "B3"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[format('app-camanager-{0}', parameters('suffix'))]",
              "location": "[parameters('location')]",
              "kind": "app,linux",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', 'plan-camanager')]",
                "httpsOnly": true,
                "publicNetworkAccess": "Disabled",
                "virtualNetworkSubnetId": "[parameters('snetAppId')]",
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|8.0",
                  "vnetRouteAllEnabled": true
                },
                "keyVaultReferenceIdentity": "[parameters('identityId')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', 'plan-camanager')]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', format('app-camanager-{0}', parameters('suffix')), 'appsettings')]",
              "properties": {
                "KeyVault__Url": "[parameters('keyVaultUrl')]",
                "AzureAd__TenantId": "[parameters('tenantId')]",
                "WEBSITE_RUN_FROM_PACKAGE": "[format('https://github.com/{0}/releases/latest/download/latest.zip', parameters('githubRepo'))]",
                "AzureWebJobsStorage__accountName": "[parameters('storageAccountName')]",
                "AzureWebJobsStorage__credential": "managedidentity",
                "AzureWebJobsStorage__clientId": "[parameters('identityClientId')]",
                "AppTitle": "[parameters('appTitle')]",
                "ApplicationInsights__ConnectionString": "[parameters('appInsightsConnectionString')]",
                "Storage__AuditTableName": "[parameters('auditTableName')]",
                "Storage__AccountName": "[parameters('storageAccountName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', format('app-camanager-{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-04-01",
              "name": "pe-app-camanager",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('snetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "psc-app",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', format('app-camanager-{0}', parameters('suffix')))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', format('app-camanager-{0}', parameters('suffix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', 'pe-app-camanager', 'pdns-app-group')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurewebsites-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('pdnsAppId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', 'pe-app-camanager')]"
              ]
            }
          ],
          "outputs": {
            "appName": {
              "type": "string",
              "value": "[format('app-camanager-{0}', parameters('suffix'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-keyvault')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-logging')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-network')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-storage')]"
      ]
    }
  ]
}